<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">

    </nav>

    <div class="container my-5">
      <h1>Hello, world!</h1>
      <div class="col-lg-8 px-0">
        <p class="fs-5">You've successfully loaded up the Bootstrap starter example. It includes <a href="https://getbootstrap.com/">Bootstrap 5</a> via the <a href="https://www.jsdelivr.com/package/npm/bootstrap">jsDelivr CDN</a> and includes an additional CSS and JS file for your own code.</p>
        <p>Feel free to download or copy-and-paste any parts of this example.</p>

        <hr class="col-1 my-4">

      </div>
    </div>

    <div class="container my-3">
        <div class="input-group">
            <input type="file" class="form-control" id="iptFilePDF" aria-label="Upload" accept="application/pdf">
            <button class="btn btn-outline-secondary" type="button" id="iptFilePDFSend">Salvar arquivo</button>
        </div>
    </div>


    <div class="container my-5">
      <div class="card" style="width: 12rem;">
        <img id="imgPdf" class="card-img-top" src="/dist/pdf-icon-shadow.png" alt="Card image cap">
        <div class="card-body">
          <p class="card-text" id="cardArquivo" style="display:none"></p>
        </div>
      </div>
    </div>

    <div class="container my-3">
      <div class="input-group mb-2">
        <input id="iptPDFLeitor" type="text" class="form-control" placeholder="pdf a ser processado" aria-label="pdf a ser processado" aria-describedby="button-addon2">
        <button class="btn btn-outline-secondary" type="button" id="btnParsePDF">Ler PDF</button>
      </div>
    </div>
    
    <div class="container my-5">
      <div class="card" style="width: 12rem;">
        <img id="imgCSV" class="card-img-top" src="/dist/csv-icon-shadow.png" alt="csv imagem">
        <div class="card-body">
          <button id="btnDownloadCSV" type="button" class="btn btn-outline-success" >Baixar Arquivo</button>
        </div>
      </div>
    </div>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    <script>

        window.onload = function(){
            
            const iptFile = document.querySelector(`#iptFilePDF`);
            const iptPDFLeitor = document.querySelector(`#iptPDFLeitor`);

            const btnParsePDF = document.querySelector(`#btnParsePDF`);
            const btnSendPDF = document.querySelector(`#iptFilePDFSend`);

            
        
            const elImgPDF = document.querySelector(`#imgPdf`);
            const elCardArquivo = document.querySelector(`#cardArquivo`);

            btnParsePDF.onclick = async () => {

              const rawResponse = await fetch('https://naoqpw313h.execute-api.sa-east-1.amazonaws.com/homolog', {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({output: 'csv'})
              });

              const content = await rawResponse.json();

              console.log(content);

            }

            btnSendPDF.onclick = async () => {

                const formData = new FormData();
                let elFile = iptFile.files[0];
                
                formData.append('file', elFile);

                let fname = elFile.name;

                fname = encodeURIComponent(fname);

                var resp = await fetch(`https://hz9sz0yfub.execute-api.sa-east-1.amazonaws.com/homolog?fileName=${fname}`
                , {
                    method: "GET"
                  });  

                var jobj = await resp.json();

                console.log(jobj.fileUploadURL)

                fetch(`${jobj.fileUploadURL || '/errror'}`, {
                  method: 'PUT',
                  body: formData
                })
                .then(response => {

                  const currTime = new Date().toLocaleTimeString('pt-BR');
                
                  if (response.ok) {

                    let msg =  `Arquivo ${fname} salvo na nuvem em ${currTime}`;
                    elImgPDF.src = `/dist/pdf-icon.png?${Math.random()}`
                    elCardArquivo.innerText = msg;
                    elCardArquivo.setAttribute('style','');

                    iptPDFLeitor.value = fname;

                    return `sucesso`
                  } else {

                    throw new Error('Tivemos um erro');
                  }
                })
                .then(data => {
                  console.log('Server response:', data);
                })
                .catch(error => {
                  console.error('Error uploading file:', error);
                });
                

                
            }

        }
    </script>
  </body>
</html>
